<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Proxy Reverse</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 220px;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-title {
            padding: 18px 16px;
            font-size: 1.1em;
            font-weight: bold;
            color: #58a6ff;
            border-bottom: 1px solid #30363d;
        }
        .sidebar-title span { color: #3fb950; }
        .nav-item {
            padding: 12px 16px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-item:hover { background: #1f2937; }
        .nav-item.active {
            background: #1f2937;
            border-left-color: #58a6ff;
            color: #58a6ff;
            font-weight: 600;
        }
        .nav-icon { font-size: 1.2em; width: 24px; text-align: center; }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            padding: 16px 24px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.2em; color: #f0f6fc; }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .badge {
            padding: 4px 12px; border-radius: 12px;
            font-size: 0.75em; font-weight: 600;
        }
        .badge-green { background: #3fb95022; color: #3fb950; border: 1px solid #3fb950; }
        .badge-blue { background: #58a6ff22; color: #58a6ff; border: 1px solid #58a6ff; }

        /* ===== CONTENT ===== */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Tabs masquables */
        .tab-page { display: none; }
        .tab-page.active { display: block; }

        /* ===== CARDS ===== */
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 0.85em;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        /* ===== FILE CARDS ===== */
        .file-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .file-card:hover {
            border-color: #58a6ff;
            background: #161b22;
        }
        .file-card.active-file {
            border-color: #3fb950;
            background: #3fb95010;
        }
        .file-name {
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .file-icon { font-size: 1.3em; }
        .file-info { font-size: 0.8em; color: #8b949e; }

        /* ===== VIEWER ===== */
        .viewer {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 12px;
        }
        .viewer-bar {
            background: #161b22;
            padding: 8px 14px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }
        .viewer-bar .fname { color: #58a6ff; font-weight: 600; }
        .viewer-content {
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
        }
        .viewer-content pre {
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.82em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            color: #c9d1d9;
        }
        .viewer-render {
            padding: 16px;
            max-height: 350px;
            overflow-y: auto;
            background: white;
            color: black;
            border-radius: 0 0 8px 8px;
        }
        .viewer-render iframe {
            width: 100%;
            height: 300px;
            border: none;
            background: white;
        }

        /* ===== BUTTONS ===== */
        button {
            padding: 8px 16px;
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.82em;
            font-weight: 600;
            transition: all 0.15s;
            color: #c9d1d9;
            background: #21262d;
        }
        button:hover { background: #30363d; border-color: #58a6ff; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-green { background: #238636; border-color: #238636; color: white; }
        .btn-green:hover { background: #2ea043; }
        .btn-blue { background: #1f6feb; border-color: #1f6feb; color: white; }
        .btn-blue:hover { background: #388bfd; }
        .btn-sm { padding: 4px 10px; font-size: 0.75em; }

        /* ===== TABLES ===== */
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #21262d;
            font-size: 0.85em;
        }
        th { color: #8b949e; font-size: 0.75em; text-transform: uppercase; }
        tr:hover td { background: #161b2233; }

        /* ===== STATUS DOTS ===== */
        .dot {
            width: 10px; height: 10px; border-radius: 50%;
            display: inline-block; margin-right: 6px;
        }
        .dot-up { background: #3fb950; box-shadow: 0 0 6px #3fb950; }
        .dot-dn { background: #f85149; box-shadow: 0 0 6px #f85149; }
        .dot-un { background: #484f58; }

        /* ===== LOG VIEWER ===== */
        .log-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            font-family: monospace;
            font-size: 0.78em;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .log-i { color: #3fb950; }
        .log-w { color: #d29922; }
        .log-e { color: #f85149; }
        .log-d { color: #484f58; }
        .log-h { color: #58a6ff; }
        .log-req { color: #bc8cff; }

        /* ===== REQUEST BUILDER ===== */
        .req-row {
            display: flex; gap: 8px; margin-bottom: 8px;
            align-items: center;
        }
        .req-row select, .req-row input {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
        }
        .req-row input { flex: 1; }
        .resp-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            font-family: monospace;
            font-size: 0.78em;
            max-height: 350px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* ===== STATS MINI ===== */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat-mini {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            text-align: center;
        }
        .stat-mini .val {
            font-size: 1.8em;
            font-weight: bold;
        }
        .stat-mini .lbl {
            font-size: 0.75em;
            color: #8b949e;
            margin-top: 2px;
        }
        .val-green { color: #3fb950; }
        .val-blue { color: #58a6ff; }
        .val-orange { color: #d29922; }
        .val-red { color: #f85149; }

        /* ===== LIVE INDICATOR ===== */
        .live-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #3fb950;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ===== BACKEND VISUAL ===== */
        .lb-visual {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .lb-server {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            min-width: 180px;
            text-align: center;
            transition: all 0.3s;
        }
        .lb-server.hit {
            border-color: #3fb950;
            background: #3fb95015;
            box-shadow: 0 0 12px #3fb95033;
        }
        .lb-server .srv-name { font-weight: 600; color: #f0f6fc; margin-bottom: 6px; }
        .lb-server .srv-port { color: #8b949e; font-size: 0.82em; }
        .lb-server .srv-hits {
            font-size: 2em; font-weight: bold; color: #58a6ff;
            margin: 8px 0;
        }
        .lb-server .srv-bar {
            height: 6px; background: #21262d; border-radius: 3px;
            overflow: hidden; margin-top: 6px;
        }
        .lb-server .srv-bar-fill {
            height: 100%; background: #58a6ff; border-radius: 3px;
            transition: width 0.3s;
        }

        /* ===== CONFIG VIEW ===== */
        .config-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .config-block h3 {
            color: #58a6ff;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .config-block pre {
            font-family: monospace;
            font-size: 0.82em;
            color: #c9d1d9;
            line-height: 1.5;
        }
        .config-item {
            display: flex; justify-content: space-between;
            padding: 6px 0; border-bottom: 1px solid #21262d;
            font-size: 0.85em;
        }
        .config-key { color: #d29922; }
        .config-val { color: #3fb950; font-family: monospace; }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="sidebar-title">&#9881; Proxy <span>Reverse</span></div>
    <div class="nav-item active" onclick="showTab('overview')">
        <span class="nav-icon">&#128200;</span> Vue d'ensemble
    </div>
    <div class="nav-item" onclick="showTab('static')">
        <span class="nav-icon">&#128196;</span> Fichiers statiques
    </div>
    <div class="nav-item" onclick="showTab('php')">
        <span class="nav-icon">&#128024;</span> PHP
    </div>
    <div class="nav-item" onclick="showTab('backends')">
        <span class="nav-icon">&#128423;</span> Backends
    </div>
    <div class="nav-item" onclick="showTab('loadbalancer')">
        <span class="nav-icon">&#128256;</span> Load Balancing
    </div>
    <div class="nav-item" onclick="showTab('cache')">
        <span class="nav-icon">&#128190;</span> Cache
    </div>
    <div class="nav-item" onclick="showTab('security')">
        <span class="nav-icon">&#128274;</span> Sécurité
    </div>
    <div class="nav-item" onclick="showTab('logs')">
        <span class="nav-icon">&#128466;</span> Logs
    </div>
    <div class="nav-item" onclick="showTab('request')">
        <span class="nav-icon">&#128295;</span> Requête libre
    </div>
    <div class="nav-item" onclick="showTab('config')">
        <span class="nav-icon">&#9881;</span> Configuration
    </div>
</div>

<!-- MAIN -->
<div class="main">
    <div class="header">
        <h1 id="pageTitle">&#128200; Vue d'ensemble</h1>
        <div class="header-right">
            <span class="live-dot"></span>
            <span class="badge badge-green">Proxy :8085</span>
            <span class="badge badge-blue" id="headerBadge">En ligne</span>
        </div>
    </div>

    <div class="content">

        <!-- ==================== OVERVIEW ==================== -->
        <div class="tab-page active" id="tab-overview">
            <div class="stats-row" id="overviewStats">
                <div class="stat-mini"><div class="val val-blue" id="ovReq">-</div><div class="lbl">Requêtes envoyées</div></div>
                <div class="stat-mini"><div class="val val-green" id="ovOk">-</div><div class="lbl">Réponses OK</div></div>
                <div class="stat-mini"><div class="val val-red" id="ovErr">-</div><div class="lbl">Erreurs</div></div>
                <div class="stat-mini"><div class="val val-orange" id="ovAvg">-</div><div class="lbl">Latence moy.</div></div>
            </div>

            <div class="card">
                <div class="card-title">&#128423; État des Backends</div>
                <table>
                    <thead><tr><th>Adresse</th><th>Poids</th><th>État</th><th>Latence</th></tr></thead>
                    <tbody id="ovBackends"></tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title">&#128196; Fichiers du serveur</div>
                <div id="ovFiles" style="font-size:0.85em; color:#8b949e;">Chargement...</div>
            </div>

            <div class="card">
                <div class="card-title">&#128466; Dernières actions</div>
                <div id="ovLog" class="log-box" style="max-height:200px;">
                    <div class="log-i">Dashboard chargé.</div>
                </div>
            </div>
        </div>

        <!-- ==================== STATIC FILES ==================== -->
        <div class="tab-page" id="tab-static">
            <div class="card">
                <div class="card-title">&#128196; Fichiers HTML disponibles</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Clique sur un fichier pour le charger via le proxy, voir le code source et le rendu.
                </p>
                <div class="card-grid" id="staticFiles"></div>
            </div>
            <div id="staticViewer"></div>
        </div>

        <!-- ==================== PHP ==================== -->
        <div class="tab-page" id="tab-php">
            <div class="card">
                <div class="card-title">&#128024; Fichiers PHP disponibles</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Le proxy exécute PHP via <code>php-cgi</code>. Clique pour exécuter et voir le résultat.
                </p>
                <div class="card-grid" id="phpFiles"></div>
            </div>
            <div id="phpViewer"></div>
        </div>

        <!-- ==================== BACKENDS ==================== -->
        <div class="tab-page" id="tab-backends">
            <div class="card">
                <div class="card-title">&#128423; Backends configurés 
                    <button class="btn-sm btn-blue" onclick="refreshBackends()">&#8635; Rafraîchir</button>
                </div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Le proxy envoie les requêtes non-statiques vers ces backends. Le health check tourne toutes les 10s.
                </p>
                <table>
                    <thead><tr><th>Adresse</th><th>Port</th><th>Poids</th><th>État</th><th>Latence</th><th>Action</th></tr></thead>
                    <tbody id="backendTable"></tbody>
                </table>
            </div>
            <div id="backendTestResult"></div>
        </div>

        <!-- ==================== LOAD BALANCING ==================== -->
        <div class="tab-page" id="tab-loadbalancer">
            <div class="card">
                <div class="card-title">&#128256; Test du Load Balancing en temps réel</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Envoie des requêtes au proxy et observe la distribution entre backends (round-robin, least-conn, ip-hash, weighted).
                </p>
                <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                    <button class="btn-green" onclick="lbTest(10)">&#9654; Envoyer 10 requêtes</button>
                    <button class="btn-blue" onclick="lbTest(30)">&#9654; Envoyer 30 requêtes</button>
                    <button onclick="lbReset()">&#10005; Réinitialiser</button>
                </div>
                <div class="lb-visual" id="lbVisual"></div>
            </div>
            <div class="card">
                <div class="card-title">&#128203; Journal des réponses</div>
                <div id="lbLog" class="log-box" style="max-height:250px;"></div>
            </div>
        </div>

        <!-- ==================== CACHE ==================== -->
        <div class="tab-page" id="tab-cache">
            <div class="card">
                <div class="card-title">&#128190; Test du système de cache</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Envoie 2 requêtes identiques et compare les réponses et le temps de réponse.
                </p>
                <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; align-items:center;">
                    <span style="font-size:0.85em;">URL :</span>
                    <input type="text" id="cacheUrl" value="/index.html" style="background:#0d1117; border:1px solid #30363d; color:#c9d1d9; padding:8px; border-radius:6px; width:200px;">
                    <button class="btn-green" onclick="cacheTest()">&#9654; Tester le cache</button>
                </div>
            </div>
            <div id="cacheResult"></div>
        </div>

        <!-- ==================== SECURITY ==================== -->
        <div class="tab-page" id="tab-security">
            <div class="card">
                <div class="card-title">&#128274; Tests de sécurité</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Teste la résistance du proxy aux attaques courantes.
                </p>
                <button class="btn-green" onclick="securityTest()">&#9654; Lancer les tests de sécurité</button>
            </div>
            <div id="secResults"></div>
            <div class="card" style="margin-top:12px;">
                <div class="card-title">&#128683; Blacklist IP</div>
                <div id="blacklistInfo"></div>
            </div>
        </div>

        <!-- ==================== LOGS ==================== -->
        <div class="tab-page" id="tab-logs">
            <div class="card">
                <div class="card-title">&#128466; Journal d'activité du dashboard
                    <button class="btn-sm" onclick="clearLogs()">&#10005; Effacer</button>
                </div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Toutes les requêtes envoyées depuis ce dashboard sont enregistrées ici avec leurs résultats.
                </p>
                <div id="fullLog" class="log-box" style="max-height:500px;"></div>
            </div>
        </div>

        <!-- ==================== REQUEST ==================== -->
        <div class="tab-page" id="tab-request">
            <div class="card">
                <div class="card-title">&#128295; Envoyer une requête personnalisée</div>
                <div class="req-row">
                    <select id="reqMethod">
                        <option>GET</option><option>POST</option>
                        <option>HEAD</option><option>PUT</option>
                        <option>DELETE</option><option>OPTIONS</option>
                    </select>
                    <input type="text" id="reqPath" value="/" placeholder="/chemin">
                    <button class="btn-green" onclick="sendRequest()">&#9654; Envoyer</button>
                </div>
            </div>
            <div id="reqResult"></div>
        </div>

        <!-- ==================== CONFIG ==================== -->
        <div class="tab-page" id="tab-config">
            <div class="card">
                <div class="card-title">&#9881; Configuration du proxy</div>
                <p style="font-size:0.82em; color:#8b949e; margin-bottom:12px;">
                    Paramètres définis dans config.h et les fichiers de configuration.
                </p>
            </div>
            <div class="card-grid">
                <div class="config-block">
                    <h3>&#128423; Backends (backends.cfg)</h3>
                    <div class="config-item"><span class="config-key">Backend 1</span><span class="config-val">127.0.0.1:8081 (poids 3)</span></div>
                    <div class="config-item"><span class="config-key">Backend 2</span><span class="config-val">127.0.0.1:8082 (poids 2)</span></div>
                    <div class="config-item"><span class="config-key">Backend 3</span><span class="config-val">127.0.0.1:8083 (poids 1)</span></div>
                </div>
                <div class="config-block">
                    <h3>&#128190; Cache (cache_rules.cfg)</h3>
                    <div class="config-item"><span class="config-key">*.html</span><span class="config-val">10s, max 100Ko</span></div>
                    <div class="config-item"><span class="config-key">*.css</span><span class="config-val">30s, max 1Mo</span></div>
                    <div class="config-item"><span class="config-key">/*</span><span class="config-val">5s, max 50Ko</span></div>
                    <div class="config-item"><span class="config-key">/api/*</span><span class="config-val">Pas de cache</span></div>
                </div>
                <div class="config-block">
                    <h3>&#128274; Sécurité</h3>
                    <div class="config-item"><span class="config-key">Rate limit</span><span class="config-val">100 req/min</span></div>
                    <div class="config-item"><span class="config-key">Max clients</span><span class="config-val">100</span></div>
                    <div class="config-item"><span class="config-key">Timeout</span><span class="config-val">30s</span></div>
                    <div class="config-item"><span class="config-key">Blacklist</span><span class="config-val">192.168.1.100, 10.0.0.99</span></div>
                </div>
                <div class="config-block">
                    <h3>&#9881; Général (config.h)</h3>
                    <div class="config-item"><span class="config-key">Port proxy</span><span class="config-val">8085</span></div>
                    <div class="config-item"><span class="config-key">Buffer</span><span class="config-val">8192 octets</span></div>
                    <div class="config-item"><span class="config-key">Cache capacity</span><span class="config-val">100 entrées</span></div>
                    <div class="config-item"><span class="config-key">Max entry size</span><span class="config-val">10 Mo</span></div>
                    <div class="config-item"><span class="config-key">Health check</span><span class="config-val">toutes les 10s</span></div>
                    <div class="config-item"><span class="config-key">Load balancing</span><span class="config-val">Round-robin</span></div>
                </div>
            </div>
        </div>

    </div><!-- /content -->
</div><!-- /main -->

<script>
// ============================================================
// GLOBALS
// ============================================================
var totalReq = 0, totalOk = 0, totalErr = 0, totalTime = 0;
var lbHits = {};

// ============================================================
// NAVIGATION
// ============================================================
function showTab(name) {
    // Hide all
    var pages = document.querySelectorAll('.tab-page');
    for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
    var navs = document.querySelectorAll('.nav-item');
    for (var i = 0; i < navs.length; i++) navs[i].classList.remove('active');

    // Show selected
    var page = document.getElementById('tab-' + name);
    if (page) page.classList.add('active');
    navs[getTabIndex(name)].classList.add('active');

    // Update title
    var titles = {
        overview: '&#128200; Vue d\'ensemble',
        static: '&#128196; Fichiers statiques',
        php: '&#128024; Fichiers PHP',
        backends: '&#128423; Backends',
        loadbalancer: '&#128256; Load Balancing',
        cache: '&#128190; Cache',
        security: '&#128274; Sécurité',
        logs: '&#128466; Logs',
        request: '&#128295; Requête libre',
        config: '&#9881; Configuration'
    };
    document.getElementById('pageTitle').innerHTML = titles[name] || name;

    // Load content
    if (name === 'static') loadStaticFiles();
    if (name === 'php') loadPHPFiles();
    if (name === 'backends') refreshBackends();
    if (name === 'loadbalancer') initLBVisual();
    if (name === 'security') loadBlacklist();
    if (name === 'overview') loadOverview();
}

function getTabIndex(name) {
    var tabs = ['overview','static','php','backends','loadbalancer','cache','security','logs','request','config'];
    return tabs.indexOf(name);
}

// ============================================================
// HTTP helper
// ============================================================
function http(method, path) {
    return new Promise(function(resolve) {
        var start = performance.now();
        var xhr = new XMLHttpRequest();
        xhr.open(method, path, true);
        xhr.timeout = 10000;
        xhr.onload = function() {
            var ms = Math.round(performance.now() - start);
            totalReq++; totalTime += ms;
            if (xhr.status >= 200 && xhr.status < 400) totalOk++; else totalErr++;
            updateOverviewStats();
            resolve({ status: xhr.status, body: xhr.responseText || '', headers: xhr.getAllResponseHeaders() || '', time: ms, ok: xhr.status >= 200 && xhr.status < 400 });
        };
        xhr.onerror = function() {
            var ms = Math.round(performance.now() - start);
            totalReq++; totalErr++; totalTime += ms; updateOverviewStats();
            resolve({ status: 0, body: '', headers: '', time: ms, ok: false });
        };
        xhr.ontimeout = function() {
            totalReq++; totalErr++; updateOverviewStats();
            resolve({ status: 0, body: '', headers: '', time: 10000, ok: false });
        };
        xhr.send();
    });
}

function pause(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

function updateOverviewStats() {
    var avg = totalReq > 0 ? Math.round(totalTime / totalReq) : 0;
    document.getElementById('ovReq').textContent = totalReq;
    document.getElementById('ovOk').textContent = totalOk;
    document.getElementById('ovErr').textContent = totalErr;
    document.getElementById('ovAvg').textContent = avg + 'ms';
}

// ============================================================
// LOGGING
// ============================================================
function log(msg, cls) {
    cls = cls || 'i';
    var t = new Date().toLocaleTimeString();
    var line = '<div class="log-' + cls + '">[' + t + '] ' + msg + '</div>';
    
    var ovLog = document.getElementById('ovLog');
    if (ovLog) { ovLog.innerHTML += line; ovLog.scrollTop = ovLog.scrollHeight; }
    
    var fullLog = document.getElementById('fullLog');
    if (fullLog) { fullLog.innerHTML += line; fullLog.scrollTop = fullLog.scrollHeight; }
}

function clearLogs() {
    document.getElementById('fullLog').innerHTML = '<div class="log-i">Logs effacés.</div>';
}

// ============================================================
// OVERVIEW
// ============================================================
function loadOverview() {
    refreshBackendsTable('ovBackends');
    // List files
    var files = ['index.html', 'page1.html', 'index.php', 'test.php', 'dashboard.html'];
    var html = files.map(function(f) {
        var icon = f.endsWith('.php') ? '&#128024;' : '&#128196;';
        return '<span style="margin-right:16px;">' + icon + ' ' + f + '</span>';
    }).join('');
    document.getElementById('ovFiles').innerHTML = html;
}

// ============================================================
// STATIC FILES
// ============================================================
function loadStaticFiles() {
    var files = [
        { name: 'index.html', desc: 'Page d\'accueil avec test load balancing', path: '/index.html' },
        { name: 'page1.html', desc: 'Page de test cache', path: '/page1.html' },
        { name: 'dashboard.html', desc: 'Ce dashboard', path: '/dashboard.html' }
    ];
    var container = document.getElementById('staticFiles');
    container.innerHTML = '';
    files.forEach(function(f) {
        var div = document.createElement('div');
        div.className = 'file-card';
        div.innerHTML = '<div class="file-name"><span class="file-icon">&#128196;</span>' + f.name + '</div>' +
                        '<div class="file-info">' + f.desc + '</div>';
        div.onclick = function() { loadFile(f.path, f.name, 'static'); };
        container.appendChild(div);
    });
}

function loadPHPFiles() {
    var files = [
        { name: 'index.php', desc: 'Test proxy + info backend + heure serveur', path: '/index.php' },
        { name: 'test.php', desc: 'Test exécution PHP avec infos serveur', path: '/test.php' }
    ];
    var container = document.getElementById('phpFiles');
    container.innerHTML = '';
    files.forEach(function(f) {
        var div = document.createElement('div');
        div.className = 'file-card';
        div.innerHTML = '<div class="file-name"><span class="file-icon">&#128024;</span>' + f.name + '</div>' +
                        '<div class="file-info">' + f.desc + '</div>';
        div.onclick = function() { loadFile(f.path, f.name, 'php'); };
        container.appendChild(div);
    });
}

async function loadFile(path, name, type) {
    log('GET ' + path, 'req');
    
    // Highlight active card
    var container = document.getElementById(type + 'Files');
    var cards = container.querySelectorAll('.file-card');
    for (var i = 0; i < cards.length; i++) cards[i].classList.remove('active-file');
    event.currentTarget.classList.add('active-file');
    
    var viewer = document.getElementById(type + 'Viewer');
    viewer.innerHTML = '<div class="card" style="text-align:center; color:#8b949e;">&#9203; Chargement de ' + name + '...</div>';
    
    var r = await http('GET', path);
    
    log('GET ' + path + ' => HTTP ' + r.status + ' (' + r.body.length + ' octets, ' + r.time + 'ms)', r.ok ? 'i' : 'e');
    
    var statusColor = r.ok ? '#3fb950' : '#f85149';
    
    var html = '<div class="card">';
    html += '<div class="card-title">Résultat de l\'exécution</div>';
    
    // Stats
    html += '<div class="stats-row">';
    html += '<div class="stat-mini"><div class="val" style="color:' + statusColor + '">HTTP ' + r.status + '</div><div class="lbl">Status</div></div>';
    html += '<div class="stat-mini"><div class="val val-blue">' + r.body.length + '</div><div class="lbl">Octets</div></div>';
    html += '<div class="stat-mini"><div class="val val-orange">' + r.time + 'ms</div><div class="lbl">Latence</div></div>';
    html += '<div class="stat-mini"><div class="val val-green">' + (r.ok ? '&#10004;' : '&#10008;') + '</div><div class="lbl">' + (r.ok ? 'Succès' : 'Erreur') + '</div></div>';
    html += '</div>';
    html += '</div>';
    
    // Headers
    html += '<div class="viewer">';
    html += '<div class="viewer-bar"><span class="fname">&#128232; Headers de réponse</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r.headers) + '</pre></div>';
    html += '</div>';
    
    // Code source
    html += '<div class="viewer" style="margin-top:12px;">';
    html += '<div class="viewer-bar"><span class="fname">&#128209; Code source : ' + name + '</span>';
    html += '<span style="color:#8b949e; font-size:0.8em;">' + r.body.length + ' octets</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r.body) + '</pre></div>';
    html += '</div>';
    
    // Rendu HTML
    html += '<div class="viewer" style="margin-top:12px;">';
    html += '<div class="viewer-bar"><span class="fname">&#127912; Rendu navigateur</span></div>';
    html += '<div class="viewer-render"><iframe id="renderFrame" sandbox="allow-scripts"></iframe></div>';
    html += '</div>';
    
    viewer.innerHTML = html;
    
    // Fill iframe with content
    var iframe = document.getElementById('renderFrame');
    if (iframe) {
        iframe.srcdoc = r.body;
    }
}

function escHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

// ============================================================
// BACKENDS
// ============================================================
async function refreshBackends() {
    await refreshBackendsTable('backendTable');
}

async function refreshBackendsTable(tableId) {
    var tbody = document.getElementById(tableId);
    if (!tbody) return;
    
    var backends = [
        { host: '127.0.0.1', port: 8081, weight: 3 },
        { host: '127.0.0.1', port: 8082, weight: 2 },
        { host: '127.0.0.1', port: 8083, weight: 1 }
    ];
    
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#8b949e;">&#9203; Vérification...</td></tr>';
    
    // Detect backends via proxy
    var found = {};
    for (var i = 0; i < 12; i++) {
        var r = await http('GET', '/identify.html?check=' + i + '&t=' + Date.now());
        var m = r.body.match(/BACKEND-(\d)/);
        if (m) {
            var bPort = 8080 + parseInt(m[1]);
            if (!found[bPort]) found[bPort] = { latency: r.time, hits: 0 };
            found[bPort].hits++;
        }
    }
    
    tbody.innerHTML = '';
    backends.forEach(function(b) {
        var up = !!found[b.port];
        var tr = document.createElement('tr');
        var cols = '<td>' + b.host + '</td><td>' + b.port + '</td><td>' + b.weight + '</td>';
        cols += '<td><span class="dot ' + (up ? 'dot-up' : 'dot-dn') + '"></span>' + (up ? 'UP' : 'DOWN') + '</td>';
        cols += '<td>' + (up ? found[b.port].latency + 'ms' : '-') + '</td>';
        
        if (tableId === 'backendTable') {
            cols += '<td><button class="btn-sm" onclick="testBackend(' + b.port + ')">Tester</button></td>';
        }
        
        tr.innerHTML = cols;
        tbody.appendChild(tr);
        log('Backend :' + b.port + ' => ' + (up ? 'UP' : 'DOWN'), up ? 'i' : 'e');
    });
}

async function testBackend(port) {
    var div = document.getElementById('backendTestResult');
    div.innerHTML = '<div class="card" style="text-align:center; color:#8b949e;">&#9203; Test du backend :' + port + '...</div>';
    
    log('Test backend :' + port, 'req');
    var r = await http('GET', '/identify.html?t=' + Date.now());
    
    var html = '<div class="card">';
    html += '<div class="card-title">Résultat - Backend :' + port + '</div>';
    html += '<div class="stats-row">';
    html += '<div class="stat-mini"><div class="val ' + (r.ok ? 'val-green' : 'val-red') + '">HTTP ' + r.status + '</div><div class="lbl">Status</div></div>';
    html += '<div class="stat-mini"><div class="val val-orange">' + r.time + 'ms</div><div class="lbl">Latence</div></div>';
    html += '<div class="stat-mini"><div class="val val-blue">' + r.body.length + '</div><div class="lbl">Octets</div></div>';
    html += '</div>';
    html += '<div class="viewer"><div class="viewer-bar"><span class="fname">Réponse</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r.body) + '</pre></div></div>';
    html += '</div>';
    div.innerHTML = html;
    
    log('Backend :' + port + ' => HTTP ' + r.status + ' (' + r.time + 'ms)', r.ok ? 'i' : 'e');
}

// ============================================================
// LOAD BALANCING
// ============================================================
function initLBVisual() {
    var visual = document.getElementById('lbVisual');
    if (visual.children.length > 0 && !visual.querySelector('.placeholder')) return;
    
    var ports = [8081, 8082, 8083];
    visual.innerHTML = '';
    ports.forEach(function(p) {
        var div = document.createElement('div');
        div.className = 'lb-server';
        div.id = 'lb-' + p;
        div.innerHTML = '<div class="srv-name">Backend ' + (p - 8080) + '</div>' +
            '<div class="srv-port">:' + p + '</div>' +
            '<div class="srv-hits">' + (lbHits[p] || 0) + '</div>' +
            '<div style="font-size:0.75em; color:#8b949e;">requêtes</div>' +
            '<div class="srv-bar"><div class="srv-bar-fill" id="lb-bar-' + p + '" style="width:0%"></div></div>';
        visual.appendChild(div);
    });
}

async function lbTest(count) {
    initLBVisual();
    var logBox = document.getElementById('lbLog');
    log('Load balancing : envoi de ' + count + ' requêtes...', 'h');
    logBox.innerHTML += '<div class="log-h">--- Envoi de ' + count + ' requêtes ---</div>';
    
    for (var i = 0; i < count; i++) {
        var r = await http('GET', '/identify.html?lb=' + i + '&t=' + Date.now());
        var m = r.body.match(/BACKEND-(\d)/);
        var port = m ? 8080 + parseInt(m[1]) : 0;
        
        if (port) {
            lbHits[port] = (lbHits[port] || 0) + 1;
            
            // Update visual
            var srv = document.getElementById('lb-' + port);
            if (srv) {
                srv.querySelector('.srv-hits').textContent = lbHits[port];
                srv.classList.add('hit');
                setTimeout(function(s) { s.classList.remove('hit'); }, 300, srv);
            }
            
            // Update bars
            var maxHits = Math.max.apply(null, Object.values(lbHits));
            [8081, 8082, 8083].forEach(function(p) {
                var bar = document.getElementById('lb-bar-' + p);
                if (bar) bar.style.width = ((lbHits[p] || 0) / maxHits * 100) + '%';
            });
            
            logBox.innerHTML += '<div class="log-i">Req #' + (i+1) + ' => Backend ' + (port-8080) + ' (:' + port + ') - ' + r.time + 'ms</div>';
        } else {
            logBox.innerHTML += '<div class="log-e">Req #' + (i+1) + ' => Aucun backend détecté (HTTP ' + r.status + ')</div>';
        }
        logBox.scrollTop = logBox.scrollHeight;
        
        await pause(80);
    }
    
    // Summary
    var total = 0;
    var summary = Object.keys(lbHits).map(function(p) { total += lbHits[p]; return 'B' + (p-8080) + ': ' + lbHits[p]; }).join(', ');
    logBox.innerHTML += '<div class="log-h">--- Résultat : ' + summary + ' (total: ' + total + ') ---</div>';
    logBox.scrollTop = logBox.scrollHeight;
    log('Load balancing terminé : ' + summary, 'i');
}

function lbReset() {
    lbHits = {};
    document.getElementById('lbLog').innerHTML = '<div class="log-i">Compteurs réinitialisés.</div>';
    initLBVisual();
    [8081,8082,8083].forEach(function(p) {
        var srv = document.getElementById('lb-' + p);
        if (srv) srv.querySelector('.srv-hits').textContent = '0';
        var bar = document.getElementById('lb-bar-' + p);
        if (bar) bar.style.width = '0%';
    });
}

// ============================================================
// CACHE TEST
// ============================================================
async function cacheTest() {
    var url = document.getElementById('cacheUrl').value || '/index.html';
    var div = document.getElementById('cacheResult');
    div.innerHTML = '<div class="card" style="text-align:center; color:#8b949e;">&#9203; Test du cache sur ' + url + '...</div>';
    log('Cache test : ' + url, 'req');
    
    var r1 = await http('GET', url + '?t=' + Date.now());
    await pause(100);
    var r2 = await http('GET', url + '?t=' + Date.now());
    
    var same = r1.body === r2.body && r1.body.length > 0;
    var faster = r2.time < r1.time;
    
    var html = '<div class="card">';
    html += '<div class="card-title">&#128190; Résultat du test cache</div>';
    html += '<table>';
    html += '<thead><tr><th></th><th>Requête 1</th><th>Requête 2</th><th>Verdict</th></tr></thead>';
    html += '<tr><td>Status</td><td>HTTP ' + r1.status + '</td><td>HTTP ' + r2.status + '</td><td>' + (r1.status === r2.status ? '<span style="color:#3fb950">&#10004; Identique</span>' : '<span style="color:#f85149">&#10008; Différent</span>') + '</td></tr>';
    html += '<tr><td>Taille</td><td>' + r1.body.length + ' octets</td><td>' + r2.body.length + ' octets</td><td>' + (same ? '<span style="color:#3fb950">&#10004; Identique</span>' : '<span style="color:#f85149">&#10008; Différent</span>') + '</td></tr>';
    html += '<tr><td>Latence</td><td>' + r1.time + 'ms</td><td>' + r2.time + 'ms</td><td>' + (faster ? '<span style="color:#3fb950">&#10004; Plus rapide</span>' : '<span style="color:#d29922">~ Similaire</span>') + '</td></tr>';
    html += '<tr><td>Contenu</td><td colspan="2">Identique : ' + (same ? 'OUI' : 'NON') + '</td><td>' + (same ? '<span style="color:#3fb950">Cache fonctionne</span>' : '<span style="color:#d29922">Contenu variable</span>') + '</td></tr>';
    html += '</table></div>';
    
    // Show body comparison
    html += '<div class="viewer" style="margin-top:12px;">';
    html += '<div class="viewer-bar"><span class="fname">Réponse 1 (' + r1.body.length + ' octets)</span><span style="color:#8b949e">' + r1.time + 'ms</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r1.body.substring(0, 1000)) + '</pre></div>';
    html += '</div>';
    
    html += '<div class="viewer" style="margin-top:12px;">';
    html += '<div class="viewer-bar"><span class="fname">Réponse 2 (' + r2.body.length + ' octets)</span><span style="color:#8b949e">' + r2.time + 'ms</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r2.body.substring(0, 1000)) + '</pre></div>';
    html += '</div>';
    
    div.innerHTML = html;
    log('Cache test : ' + (same ? 'IDENTIQUE' : 'DIFFÉRENT') + ' | R1=' + r1.time + 'ms R2=' + r2.time + 'ms', same ? 'i' : 'w');
}

// ============================================================
// SECURITY TESTS
// ============================================================
async function securityTest() {
    var div = document.getElementById('secResults');
    div.innerHTML = '';
    
    var tests = [
        { name: 'Path traversal (/../../../etc/passwd)', method: 'GET', path: '/../../../etc/passwd', 
          check: function(r) { return r.body.indexOf('root:') < 0; }, 
          good: 'Accès bloqué', bad: 'DANGER: fichier système accessible !' },
        { name: 'Path traversal (/../../etc/shadow)', method: 'GET', path: '/../../etc/shadow',
          check: function(r) { return r.body.indexOf('root:') < 0; },
          good: 'Accès bloqué', bad: 'DANGER !' },
        { name: 'Double slash (//etc/passwd)', method: 'GET', path: '//etc/passwd',
          check: function(r) { return r.status === 403 || r.status === 404 || r.body.indexOf('root:') < 0; },
          good: 'Bloqué correctement', bad: 'Risque potentiel' },
        { name: 'Méthode DELETE', method: 'DELETE', path: '/index.html',
          check: function(r) { return r.status > 0; },
          good: 'Serveur ne crashe pas (HTTP ' + ')', bad: 'Problème' },
        { name: 'URL très longue (2000 chars)', method: 'GET', path: '/' + 'A'.repeat(2000),
          check: function(r) { return r.status > 0 || r.status === 0; },
          good: 'Géré correctement', bad: 'Problème' },
        { name: 'Stabilité post-attaque', method: 'GET', path: '/',
          check: function(r) { return r.status === 200; },
          good: 'Proxy toujours en ligne', bad: 'Proxy instable !' }
    ];
    
    for (var i = 0; i < tests.length; i++) {
        var t = tests[i];
        log('Sécurité : ' + t.name, 'req');
        
        var r = await http(t.method, t.path);
        var ok = t.check(r);
        
        var card = document.createElement('div');
        card.className = 'card';
        card.style.borderLeft = '4px solid ' + (ok ? '#3fb950' : '#f85149');
        card.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center;">' +
            '<div>' +
            '<div style="font-weight:600; color:' + (ok ? '#3fb950' : '#f85149') + ';">' + (ok ? '&#10004; ' : '&#10008; ') + t.name + '</div>' +
            '<div style="font-size:0.82em; color:#8b949e; margin-top:4px;">HTTP ' + r.status + ' | ' + r.time + 'ms | ' + r.body.length + ' octets</div>' +
            '</div>' +
            '<div style="color:' + (ok ? '#3fb950' : '#f85149') + '; font-weight:600;">' + (ok ? t.good : t.bad) + '</div>' +
            '</div>';
        div.appendChild(card);
        
        log('  => ' + (ok ? 'PASS' : 'FAIL') + ' HTTP ' + r.status, ok ? 'i' : 'e');
        await pause(300);
    }
}

function loadBlacklist() {
    var div = document.getElementById('blacklistInfo');
    div.innerHTML = '<div class="config-item"><span class="config-key">IP bloquées</span><span class="config-val">192.168.1.100, 10.0.0.99</span></div>' +
        '<p style="font-size:0.82em; color:#8b949e; margin-top:8px;">Fichier : config/blacklist.txt</p>';
}

// ============================================================
// CUSTOM REQUEST
// ============================================================
async function sendRequest() {
    var method = document.getElementById('reqMethod').value;
    var path = document.getElementById('reqPath').value || '/';
    var div = document.getElementById('reqResult');
    
    div.innerHTML = '<div class="card" style="text-align:center; color:#8b949e;">&#9203; ' + method + ' ' + path + '...</div>';
    log(method + ' ' + path, 'req');
    
    var r = await http(method, path);
    
    var html = '<div class="card">';
    html += '<div class="card-title">Résultat</div>';
    html += '<div class="stats-row">';
    html += '<div class="stat-mini"><div class="val ' + (r.ok ? 'val-green' : 'val-red') + '">HTTP ' + r.status + '</div><div class="lbl">Status</div></div>';
    html += '<div class="stat-mini"><div class="val val-blue">' + r.body.length + '</div><div class="lbl">Octets</div></div>';
    html += '<div class="stat-mini"><div class="val val-orange">' + r.time + 'ms</div><div class="lbl">Latence</div></div>';
    html += '</div></div>';
    
    html += '<div class="viewer"><div class="viewer-bar"><span class="fname">Headers</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r.headers) + '</pre></div></div>';
    
    html += '<div class="viewer" style="margin-top:12px;"><div class="viewer-bar"><span class="fname">Body</span><span style="color:#8b949e">' + r.body.length + ' octets</span></div>';
    html += '<div class="viewer-content"><pre>' + escHtml(r.body) + '</pre></div></div>';
    
    if (r.ok && (path.endsWith('.html') || path.endsWith('.php') || path === '/')) {
        html += '<div class="viewer" style="margin-top:12px;"><div class="viewer-bar"><span class="fname">Rendu</span></div>';
        html += '<div class="viewer-render"><iframe id="reqFrame" sandbox="allow-scripts"></iframe></div></div>';
    }
    
    div.innerHTML = html;
    
    var frame = document.getElementById('reqFrame');
    if (frame) frame.srcdoc = r.body;
    
    log(method + ' ' + path + ' => HTTP ' + r.status + ' (' + r.body.length + 'o, ' + r.time + 'ms)', r.ok ? 'i' : 'e');
}

// ============================================================
// INIT
// ============================================================
window.onload = function() {
    log('Dashboard chargé - proxy ' + window.location.origin, 'd');
    loadOverview();
};
</script>
</body>
</html>
